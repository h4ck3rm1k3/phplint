#!/bin/bash
# Build the pure-C version from the M2 source.

PROJECT=$(cd $(dirname $0)/.. && pwd) || exit 1


# Move to the project root dir.:
# =============================
cd $PROJECT || exit 1

dst="phplint-pure-c-$(cat $PROJECT/VERSION)"

rm -fr ../$dst
mkdir ../$dst || exit 1

cp README  ../$dst/README.txt || exit 1
cp LICENSE ../$dst/LICENSE.txt || exit 1
cp VERSION ../$dst/VERSION.txt || exit 1
cp CHANGES ../$dst/CHANGES.txt || exit 1
cp phpl    ../$dst || exit 1
cp phplint.tk ../$dst || exit 1
cp -r modules ../$dst || exit 1
cp -r stdlib  ../$dst || exit 1
cp -r doc     ../$dst || exit 1
mkdir ../$dst/src
cp src/*.c ../$dst/src
mkdir ../$dst/utils
cp utils/make-libraries-doc ../$dst
cp example-* ../$dst


# Move to the destination dir.:
# ============================
cd ../$dst || exit 1

# Remove CVS dirs.:
find . -type d -name CVS -exec rm -rf {} \;

mkdir include
cp ../m2/configure . || exit 1
cp ../m2/include/alloca.c include || exit 1
cp ../m2/include/vasprintf.c include || exit 1

cp  ../m2/lib/m2runtime.c \
	../m2/lib/m2.c \
	../m2/lib/buffer.c \
	../m2/lib/str.c \
	../m2/lib/io.c \
	src || exit 1

echo Remove pathfile dependencies:
for f in src/*.c; do
	if grep -q "/home/salsi/src/m2/lib/" $f; then
		echo -e ",s:/home/salsi/src/m2/lib/::g\nw" | ed -s $f
	fi
done

echo Generate the "compile" script:
{
	echo "./configure || exit 1"
	echo "echo Compiling..."
	echo "if grep -q USE_GC include/missing.c; then"
	echo "    cc -lgc src/phplint.c -o src/phplint"
	echo "else"
	echo "    cc src/phplint.c -o src/phplint"
	echo "fi || exit 1"
	echo "echo Now running PHPLint:"
	echo "echo"
	echo "src/phplint --version"
} > compile
chmod +x compile

# Generate INSTALL.txt file:
{
	echo "PHPLint pure-C version intallation"
	echo "=================================="
	echo
	echo "Compiling"
	echo "---------"
	echo "This is the pure-C version of the PHPLint parser and validator"
	echo "built from the original M2 source. To configure and compile"
	echo "simply run the compile script:"
	echo
	echo "   \$ ./compile"
	echo
	echo "Installation"
	echo "------------"
	echo "Simply copy the executable program src/phplint[.exe] and the"
	echo "directory modules/ somewhere. That's all!"
	echo
	echo "Typical usage"
	echo "-------------"
	echo
	echo "   $ ./phpl YourProgram.php"
	echo
	echo "or if you have tcl/tk installed:"
	echo
	echo "   $ ./phplint.tk YourProgram.php"
	echo
	echo "For more info, all the available documentation is under doc/."
	echo "Beginners of PHPLint should start reading the tutorial first,"
	echo "then the manual for more details."
	echo "Please visit http://www.icosaedro.it/phplint/ to check for updates."
	echo
	echo "- Umberto Salsi <phplint@icosaedro.it>"
} > INSTALL.txt


# Final check:
./compile || exit 1
./phpl --no-overall \
	--no-print-notices \
	--is-module \
	--no-print-source \
	modules/standard || exit 1
# Remove files generated by the 'compile' script:
rm src/phplint include/missing.c


# Compress package:
cd ..
tar chf - $dst --owner=root --group=root | gzip > /tmp/$dst.tar.gz
rm -fr $dst
echo "Distribution package /tmp/$dst.tar.gz done."
